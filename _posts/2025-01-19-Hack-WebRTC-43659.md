---
layout: post
title: Hack WebRTC 43659
tags:
    - å®æ—¶å¤šåª’ä½“
    - WebRTC
---

å†æ¬¡æ—¶å…‰é£é€ï¼Œè·ç¦»ä¸Šæ¬¡è€—æ—¶åŠå¹´å¤šçš„[æ›´æ–° HackWebRTC åˆ° 108 release](/2023-09-23-Hack-WebRTC-38316/index.html) ä¹Ÿå·²ç»è¿‡å»äº†è¿‘ä¸€å¹´åŠã€‚

è¿™ä¸€å¹´åŠé‡Œï¼Œå‘ç”Ÿçš„äº‹æƒ…æœ‰ç‚¹å¤šã€‚é¦–å…ˆæ˜¯ OWT åœ¨ 24 å¹´ 10 æœˆä»½æŠŠä»“åº“éƒ½ archive äº†ï¼Œå¹¶åœ¨ 11 æœˆåº•è§£æ•£äº†å¾®ä¿¡äº¤æµç¾¤ã€‚ç„¶åæ˜¯ OWT æŠŠ RTP åè®®æ ˆé‡Œ H265 ç›¸å…³çš„ä»£ç ï¼Œéƒ½åˆå…¥äº† WebRTC å®˜æ–¹ä»“åº“é‡Œã€‚æœ€åï¼ŒWebRTC ä¹Ÿè¿æ¥äº† m133 ç‰ˆæœ¬ï¼Œåˆæ–°å¢äº†äº”åƒå¤šä¸ªæäº¤ã€‚

## TL; DR

ä¸å–œæ¬¢å¬æ•…äº‹ï¼Œåªå¯¹ä»£ç å¹²è´§æ„Ÿå…´è¶£çš„æœ‹å‹ï¼Œå¯ä»¥ç›´æ¥çœ‹ [hack_webrtc_43659 åˆ†æ”¯](https://github.com/HackWebRTC/webrtc/tree/hack_webrtc_43659)ã€‚

## å‡çº§è¿‡ç¨‹

è¿™æ¬¡å‡çº§çš„è¿‡ç¨‹æ˜¯ç›®å‰æœ€é¡ºåˆ©çš„ä¸€æ¬¡ï¼Œå› ä¸ºå‡ ä¹æ‰€æœ‰ H265 æ”¯æŒçš„ C++ ä»£ç éƒ½å·²ç»åˆå…¥ WebRTC å®˜æ–¹ä»“åº“äº†ï¼Œæ²¡æœ‰äº†é‚£ä¹ˆå¤šå†²çªå¤„ç†ã€é—®é¢˜è°ƒè¯•ï¼ˆä¸è¿‡æˆ‘ä¸€å¼€å§‹å¹¶ä¸ç¡®è®¤è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥è¿˜æ˜¯å¤„ç†äº†æ‰€æœ‰çš„å†²çªï¼Œç¼–è¯‘å°è¯•æ‰ç¡®è®¤äº†è¿™ä¸€ç‚¹çš„ï¼‰ã€‚

åœ¨ macOS 15.2 + Xcode 16.2 çš„ç»„åˆä¸‹ï¼ŒWebRTC iOS ç¼–è¯‘æ¯«æ— é—®é¢˜ã€‚

åŒæ ·çš„ï¼ŒåŒç«¯çš„ gn å‘½ä»¤éƒ½éœ€è¦æ›´æ–°äº†ã€‚

iOS ä¹‹å‰çš„ args å‚æ•°æ˜¯ï¼š

```bash
target_os="ios"
target_cpu="arm64"
rtc_enable_symbol_export=true
ios_enable_code_signing=false
is_component_build=false
use_goma=false
is_debug=true
enable_dsyms=true
rtc_include_tests=false
```

è¿™æ¬¡éœ€è¦æ›´æ–°ä¸ºï¼š

```bash
target_os="ios"
target_cpu="arm64"
target_environment="device"
proprietary_codecs=true
rtc_enable_symbol_export=true
ios_enable_code_signing=false
is_component_build=false
is_debug=true
enable_dsyms=true
rtc_include_tests=false
```

å³éœ€è¦åŠ ä¸Š `target_environment="device"`ï¼ˆç¼–è¯‘æ¨¡æ‹Ÿå™¨æ—¶è®¾ç½®ä¸º simulatorï¼‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š

```bash
ERROR at //build/config/apple/mobile_config.gni:63:3: Assertion failed.
  assert(filter_include([ target_environment ], _target_environments) != [],
  ^-----
target_environment must be in ["simulator", "device", "catalyst"]:
See //build/config/ios/ios_sdk.gni:5:1: whence it was imported.
import("//build/config/apple/mobile_config.gni")
^----------------------------------------------
See //build/config/sysroot.gni:73:5: whence it was imported.
    import("//build/config/ios/ios_sdk.gni")
    ^--------------------------------------
See //build/config/linux/pkg_config.gni:5:1: whence it was imported.
import("//build/config/sysroot.gni")
^----------------------------------
See //BUILD.gn:24:1: whence it was imported.
import("//build/config/linux/pkg_config.gni")
^-------------------------------------------
```

ä»¥åŠåŠ ä¸Š `proprietary_codecs=true` ä»¥å¯ç”¨ H265 çš„æ”¯æŒã€‚

ç„¶åéœ€è¦å»æ‰ `use_goma=false` è¿™ä¸ªæ— ç”¨å‚æ•°ã€‚

Android çš„ args å‚æ•°è¦æ›´æ–°ä¸ºï¼š

```bash
target_os="android"
target_cpu="arm64"
is_debug=false
proprietary_codecs=true
is_component_build=false
rtc_include_tests=false
enable_rust=true
enable_rust_cxx=true
```

é™¤äº† `proprietary_codecs=true`ï¼Œä¸»è¦æ˜¯éœ€è¦åŠ ä¸Š `enable_rust=true enable_rust_cxx=true` è¿™ä¸¤ä¸ªé€‰é¡¹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š

```bash
ERROR at //build/rust/rust_target.gni:220:3: Assertion failed.
  assert(!defined(invoker.cxx_bindings) || enable_rust_cxx,
  ^-----
cxx bindings are not supported when building rust targets outside the Chromium build.
See //build/rust/rust_static_library.gni:214:3: whence it was called.
  rust_target(_target_name) {
  ^--------------------------
See //base/test/BUILD.gn:42:1: whence it was called.
rust_static_library("test_rust_logger_consumer") {
^-------------------------------------------------
See //testing/android/native_test/BUILD.gn:22:5: which caused the file to be included.
    "//base/test:test_support",
```

çœ‹èµ·æ¥ Android ç«¯å·²ç»å¼€å§‹åœ¨æ¢ç´¢ä½¿ç”¨ Rust äº†ï¼Œè¿™ä¸ªæˆ‘ä»¬ä»¥åå†ä¸€æ¢ç©¶ç«Ÿã€‚

è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ Android çš„ Java ä»£ç å·²ç»å¼€å§‹ä½¿ç”¨ Java 11 çš„ç‰¹æ€§äº†ï¼Œæ‰€ä»¥ Gradle é‡Œéœ€è¦è®¾ç½®ä½¿ç”¨ Java 11ã€‚

å› ä¸ºå‡ ä¹æ‰€æœ‰ H265 æ”¯æŒçš„ C++ ä»£ç éƒ½å·²ç»åˆå…¥ WebRTC å®˜æ–¹ä»“åº“ï¼Œæ‰€ä»¥æ·»åŠ  H265 çš„æ”¯æŒï¼Œå°±åªéœ€è¦æŠŠç¡¬ç¼–ç¡¬è§£çš„ Java/ObjC ä»£ç  cherry-pick è¿‡æ¥å°±è¡Œäº†ï¼Œå˜æ›´é‡å¤§å¤§å‡å°‘ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿå¾ˆé¡ºåˆ©ï¼Œæ²¡é‡åˆ°ä»€ä¹ˆå‘ã€‚

ä¸è¿‡æœ‰ä¸¤ä¸ªå°ç‚¹éœ€è¦æ³¨æ„ï¼š

1. gn å‘½ä»¤çš„ args å‚æ•°éœ€è¦åŠ ä¸Š `proprietary_codecs=true`ï¼ˆå‰é¢å·²ç»è¯´äº†ï¼‰ï¼›
2. éœ€è¦è®¾ç½® `WebRTC-Video-H26xPacketBuffer` field trailï¼Œä»¥å¯ç”¨æ–°çš„ packet bufferï¼ŒåŒç«¯å¯ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```java
// iOS
NSDictionary *fieldTrials = @{
    @"WebRTC-Video-H26xPacketBuffer": @"Enabled"
};
RTCInitFieldTrialDictionary(fieldTrials);

// Android
fieldTrials += "WebRTC-Video-H26xPacketBuffer/Enabled/";
PeerConnectionFactory.initialize(
    PeerConnectionFactory.InitializationOptions.builder(appContext)
        .setFieldTrials(fieldTrials)
        ...);
```

æ¥ç€è¿˜æ˜¯ cherry-pick æœ¬åœ°å½•åˆ¶ã€ä¼´å¥åŠŸèƒ½ï¼Œè¿™æ¬¡æˆ‘å‘ç° WebRTC å·²ç»æŠŠ in-tree ffmpeg å‡çº§åˆ°äº† 7.1ï¼Œæ‰€ä»¥è¿˜éœ€è¦é€‚é… ffmpeg ä» 5.1 å‡çº§åˆ° 7.1 çš„æ¥å£å˜åŠ¨ã€‚

ä¸»è¦å°±æ˜¯é€‚é…äº† swresample åˆå§‹åŒ–æ—¶è®¾ç½®å£°é“çš„å˜åŒ–ï¼ˆå‚è€ƒ ffmpeg çš„ `resample_audio.c` è¿™ä¸ª exampleï¼‰ï¼š

```c++
int64_t input_channel_layout =
    (input_channel_num_ == 1) ? AV_CH_LAYOUT_MONO : AV_CH_LAYOUT_STEREO;
int64_t output_channel_layout =
    (output_channel_num_ == 1) ? AV_CH_LAYOUT_MONO : AV_CH_LAYOUT_STEREO;
av_opt_set_int(context_.get(), "in_channel_layout", input_channel_layout, 0);

// ===>

AVChannelLayout input_channel_layout;
if (input_channel_num_ == 1) {
    input_channel_layout = AV_CHANNEL_LAYOUT_MONO;
} else {
    input_channel_layout = AV_CHANNEL_LAYOUT_STEREO;
}
av_opt_set_chlayout(context_.get(), "in_chlayout", &input_channel_layout, 0);
```

æå®š ğŸ¤

æ€»çš„æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒé¡ºåˆ©ï¼ŒåŸºæœ¬åªèŠ±äº†ä¸€ä¸ªå‘¨æœ«çš„æ—¶é—´å°±å®Œæˆäº†è¿™æ¬¡å‡çº§ï¼Œä¸‹æ¬¡å†åˆ° 15x ç‰ˆæœ¬çš„æ—¶å€™å†çœ‹çœ‹å‡çº§ä¸€æ³¢ï¼Œæœ‹å‹ä»¬å†ä¼š~
